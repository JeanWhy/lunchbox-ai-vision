
<!DOCTYPE html>
<html>
<head>
  <title>AI ë„ì‹œë½ ì¶”ì²œ ê²°ê³¼</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="logo-container">
    <img src="{{ url_for('static', filename='img/lunchbox.png') }}" alt="ë„ì‹œë½ ë¡œê³ ">
  </div>
  
  <h2>{{ texts.ai_result_title }}</h2>
  
  <div class="result-container">
    <div class="intro-section">
      <h3>{{ texts.custom_menu }}</h3>
      <p>{{ texts.custom_description }}</p>
    </div>
    
    <div class="loading-section" id="loadingSection">
      <div class="main-loading">
        <div class="loading-spinner-large"></div>
        <h3>{{ texts.ai_generating }}</h3>
        <p>{{ texts.please_wait }}</p>
      </div>
    </div>
    
    <div class="menu-cards-container" id="menuContainer" style="display: none;">
      <div class="result-text" style="display: none;">{{ result | safe }}</div>
      <div id="menuCards"></div>
    </div>
    
    <div class="action-section">
      <a href="/" class="back-button">
        {{ texts.new_recommendation }}
      </a>
    </div>
  </div>

  <script>
    const loadingSection = document.getElementById('loadingSection');
    const menuContainer = document.getElementById('menuContainer');
    const menuCards = document.getElementById('menuCards');
    
    const texts = {
      ingredients: '{{ texts.ingredients }}',
      instructions: '{{ texts.instructions }}',
      nutrition: '{{ texts.nutrition }}',
      imageGenerating: '{{ texts.image_generating }}',
      errorOccurred: '{{ texts.error_occurred }}',
      tryAgain: '{{ texts.try_again }}',
      retryButton: '{{ texts.retry_button }}'
    };
    
    // URLì—ì„œ request_id ê°€ì ¸ì˜¤ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    const requestId = urlParams.get('id');
    
    if (!requestId) {
      window.location.href = '/';
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ AI ì¶”ì²œ ìš”ì²­
    window.addEventListener('load', function() {
      fetch('/get_recommendation', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          request_id: requestId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        
        // ë¡œë”© ì„¹ì…˜ ìˆ¨ê¸°ê³  ê²°ê³¼ í‘œì‹œ
        loadingSection.style.display = 'none';
        menuContainer.style.display = 'block';
        
        // ê²°ê³¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        document.querySelector('.result-text').textContent = data.result;
        
        // ë©”ë‰´ ì¹´ë“œ ìƒì„±
        displayMenuCards(data.result);
        
        // ì´ë¯¸ì§€ ìƒì„± ì‹œì‘
        generateMenuImages(data.result);
      })
      .catch(error => {
        console.error('ì¶”ì²œ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
        loadingSection.innerHTML = `
          <div class="error-message">
            <h3>${texts.errorOccurred}</h3>
            <p>${texts.tryAgain}</p>
            <a href="/" class="back-button">${texts.retryButton}</a>
          </div>
        `;
      });
    });
    
    function displayMenuCards(resultText) {
      // AI ì‘ë‹µì„ íŒŒì‹±í•˜ì—¬ ê°œë³„ ë©”ë‰´ ì¹´ë“œë¡œ í‘œì‹œ
      
      // ** ë©”ë‰´ëª… ** íŒ¨í„´ìœ¼ë¡œ ë©”ë‰´ ë¶„ë¦¬
      const menuPattern = /\*\*(.*?)\*\*/g;
      const menuMatches = [...resultText.matchAll(menuPattern)];
      
      if (menuMatches.length === 0) {
        // íŒ¨í„´ì´ ì—†ìœ¼ë©´ ì›ë³¸ í…ìŠ¤íŠ¸ í‘œì‹œ
        menuCards.innerHTML = `
          <div class="menu-card">
            <div class="menu-card-content">
              <div class="menu-section">
                <pre>${resultText}</pre>
              </div>
            </div>
          </div>
        `;
        return;
      }
      
      const uniqueMenus = new Map(); // ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•œ Map
      
      menuMatches.forEach((match, index) => {
        const menuName = match[1].trim();
        const startIndex = match.index + match[0].length;
        const nextIndex = index < menuMatches.length - 1 ? menuMatches[index + 1].index : resultText.length;
        const content = resultText.substring(startIndex, nextIndex).trim();
        
        // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë©”ë‰´ì¸ì§€ í™•ì¸
        if (uniqueMenus.has(menuName)) {
          // ê¸°ì¡´ ë‚´ìš©ê³¼ ìƒˆ ë‚´ìš©ì„ í•©ì¹¨
          const existingContent = uniqueMenus.get(menuName);
          uniqueMenus.set(menuName, existingContent + '\n\n' + content);
        } else {
          uniqueMenus.set(menuName, content);
        }
      });
      
      // ìœ ë‹ˆí¬í•œ ë©”ë‰´ë“¤ë¡œ ì¹´ë“œ ìƒì„±
      let cardIndex = 0;
      uniqueMenus.forEach((content, menuName) => {
        // ë‹¤êµ­ì–´ ëŒ€ì‘ ì„¹ì…˜ íŒŒì‹±
        let ingredients = '';
        let instructions = '';
        let nutrition = '';
        
        // í•œêµ­ì–´ ë° ì˜ì–´ íŒ¨í„´ ëª¨ë‘ ì§€ì›
        const ingredientPatterns = [
          /ì¬ë£Œ:\s*(.*?)(?=\n(?:ë§Œë“œëŠ” ë²•:|ì˜ì–‘ì •ë³´:|Instructions:|Nutrition Info:)|$)/s,
          /Ingredients:\s*(.*?)(?=\n(?:ì¬ë£Œ:|ë§Œë“œëŠ” ë²•:|ì˜ì–‘ì •ë³´:|Instructions:|Nutrition Info:)|$)/s
        ];
        
        const instructionPatterns = [
          /ë§Œë“œëŠ” ë²•:\s*(.*?)(?=\n(?:ì¬ë£Œ:|ì˜ì–‘ì •ë³´:|Ingredients:|Instructions:|Nutrition Info:)|$)/s,
          /Instructions:\s*(.*?)(?=\n(?:ì¬ë£Œ:|ë§Œë“œëŠ” ë²•:|ì˜ì–‘ì •ë³´:|Ingredients:|Nutrition Info:)|$)/s
        ];
        
        const nutritionPatterns = [
          /ì˜ì–‘ì •ë³´:\s*(.*?)(?=\n(?:ì¬ë£Œ:|ë§Œë“œëŠ” ë²•:|Ingredients:|Instructions:|Nutrition Info:)|$)/s,
          /Nutrition Info:\s*(.*?)(?=\n(?:ì¬ë£Œ:|ë§Œë“œëŠ” ë²•:|ì˜ì–‘ì •ë³´:|Ingredients:|Instructions:)|$)/s
        ];
        
        // íŒ¨í„´ ë§¤ì¹­
        for (let pattern of ingredientPatterns) {
          const match = content.match(pattern);
          if (match) { ingredients = match[1].trim(); break; }
        }
        
        for (let pattern of instructionPatterns) {
          const match = content.match(pattern);
          if (match) { instructions = match[1].trim(); break; }
        }
        
        for (let pattern of nutritionPatterns) {
          const match = content.match(pattern);
          if (match) { nutrition = match[1].trim(); break; }
        }
        
        // íŒŒì‹±ë˜ì§€ ì•Šì€ ë‚˜ë¨¸ì§€ ë‚´ìš©
        let remainingContent = content;
        if (ingredients) remainingContent = remainingContent.replace(/ì¬ë£Œ:\s*.*?(?=\n(?:ë§Œë“œëŠ” ë²•:|ì˜ì–‘ì •ë³´:)|$)/s, '');
        if (ingredients) remainingContent = remainingContent.replace(/Ingredients:\s*.*?(?=\n(?:Instructions:|Nutrition Info:)|$)/s, '');
        if (instructions) remainingContent = remainingContent.replace(/ë§Œë“œëŠ” ë²•:\s*.*?(?=\n(?:ì¬ë£Œ:|ì˜ì–‘ì •ë³´:)|$)/s, '');
        if (instructions) remainingContent = remainingContent.replace(/Instructions:\s*.*?(?=\n(?:Ingredients:|Nutrition Info:)|$)/s, '');
        if (nutrition) remainingContent = remainingContent.replace(/ì˜ì–‘ì •ë³´:\s*.*?(?=\n(?:ì¬ë£Œ:|ë§Œë“œëŠ” ë²•:)|$)/s, '');
        if (nutrition) remainingContent = remainingContent.replace(/Nutrition Info:\s*.*?(?=\n(?:Ingredients:|Instructions:)|$)/s, '');
        remainingContent = remainingContent.trim();
        
        const card = document.createElement('div');
        card.className = 'menu-card';
        
        // placeholder ì´ë¯¸ì§€ HTML ìƒì„±
        const imageHtml = `
          <div class="menu-image">
            <div class="image-placeholder" data-menu="${menuName}">
              <div class="loading-spinner"></div>
              <span>${texts.imageGenerating}</span>
            </div>
          </div>`;
        
        card.innerHTML = `
          <div class="menu-card-header">
            <span class="menu-number">${cardIndex + 1}</span>
            <h4>${menuName}</h4>
          </div>
          ${imageHtml}
          <div class="menu-card-content">
            ${ingredients ? `
              <div class="menu-section">
                <h5>${texts.ingredients}</h5>
                <p>${ingredients}</p>
              </div>
            ` : ''}
            ${instructions ? `
              <div class="menu-section">
                <h5>${texts.instructions}</h5>
                <p>${instructions}</p>
              </div>
            ` : ''}
            ${nutrition ? `
              <div class="menu-section">
                <h5>${texts.nutrition}</h5>
                <p>${nutrition}</p>
              </div>
            ` : ''}
            ${remainingContent && !ingredients && !instructions && !nutrition ? `
              <div class="menu-section">
                <pre>${remainingContent}</pre>
              </div>
            ` : ''}
          </div>
        `;
        menuCards.appendChild(card);
        cardIndex++;
      });
      
      // ë§Œì•½ íŒŒì‹±ì´ ì œëŒ€ë¡œ ì•ˆë˜ë©´ ì›ë³¸ í…ìŠ¤íŠ¸ í‘œì‹œ
      if (menuCards.children.length === 0) {
        menuCards.innerHTML = `
          <div class="menu-card">
            <div class="menu-card-content">
              <div class="menu-section">
                <pre>${resultText}</pre>
              </div>
            </div>
          </div>
        `;
      }
    }
    
    function generateMenuImages(resultText) {
      // ì´ë¯¸ì§€ ë¹„ë™ê¸° ìƒì„± ìš”ì²­
      fetch('/generate_images', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            menu_text: resultText,
            request_id: requestId
          })
        })
      .then(response => response.json())
        .then(data => {
          const menuImages = data.menu_images;
          
          // ê° placeholderë¥¼ ì‹¤ì œ ì´ë¯¸ì§€ë¡œ êµì²´
          document.querySelectorAll('.image-placeholder').forEach(placeholder => {
            const menuName = placeholder.getAttribute('data-menu');
            if (menuImages[menuName]) {
              const img = document.createElement('img');
              img.src = menuImages[menuName];
              img.alt = menuName;
              img.onerror = function() { this.style.display = 'none'; };
              img.onload = function() {
                placeholder.parentNode.replaceChild(img, placeholder);
              };
            } else {
              // ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì´ëª¨ì§€ í‘œì‹œ
              placeholder.innerHTML = '<div class="default-food-icon">ğŸ±</div>';
              placeholder.classList.add('failed');
            }
          });
        })
        .catch(error => {
          console.error('ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
          // ì˜¤ë¥˜ ë°œìƒ ì‹œ ëª¨ë“  placeholderë¥¼ ê¸°ë³¸ ì•„ì´ì½˜ìœ¼ë¡œ êµì²´
          document.querySelectorAll('.image-placeholder').forEach(placeholder => {
            placeholder.innerHTML = '<div class="default-food-icon">ğŸ±</div>';
            placeholder.classList.add('failed');
          });
        });
    }
  </script>
</body>
</html>
